{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">

<div class="chat-container">
    <div class="chat-sidebar">
        <h3>Chat History</h3>
        <button id="newChatBtn" class="btn btn-primary btn-sm mb-3">New Chat</button>
        <ul id="chatSessionsList" class="list-group">
            {% for session in chat_sessions %}
            <li class="list-group-item" data-session-id="{{ session.id }}">
                {{ session.title }} <small class="text-muted">({{ session.start_time|date:"M d, H:i" }})</small>
            </li>
            {% endfor %}
        </ul>
    </div>
    <div class="chat-main">
        <h3 id="currentChatTitle">New Chat</h3>
        <div id="chatMessages" class="chat-messages">
            <!-- Messages will be appended here by JS -->
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Type your message..." class="form-control">
            <button id="sendMessageBtn" class="btn btn-success">Send</button>
            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
            <button id="uploadImageBtn" class="btn btn-info">Upload Image</button>
        </div>
    </div>
</div>

<script>
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const newChatBtn = document.getElementById('newChatBtn');
    const chatSessionsList = document.getElementById('chatSessionsList');
    const currentChatTitle = document.getElementById('currentChatTitle');
    const uploadImageBtn = document.getElementById('uploadImageBtn');
    const imageUpload = document.getElementById('imageUpload');

    let currentSessionId = null;

    function appendMessage(sender, message, timestamp) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('chat-message', sender);
        messageElement.innerHTML = `<strong>${sender === 'user' ? 'You' : 'Kisan Mitra'}:</strong> ${message} <small>${new Date(timestamp).toLocaleTimeString()}</small>`;
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to bottom
    }

    async function sendMessage(message, isImage = false, imageUrl = null) {
        if (!message.trim() && !isImage) return;

        chatInput.value = ''; // Clear input field

        const userMessageText = isImage ? `Uploaded image: ${message}` : message;
        appendMessage('user', userMessageText, new Date());

        const requestData = {
            message: message,
            session_id: currentSessionId,
            is_image: isImage,
            image_url: imageUrl // Only send if it's an image
        };

        try {
            const response = await fetch('{% url "chat_with_ai" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}' // Django CSRF token
                },
                body: JSON.stringify(requestData)
            });
            const data = await response.json();
            if (response.ok) {
                appendMessage('ai', data.message, new Date());
                if (!currentSessionId) {
                    currentSessionId = data.session_id;
                    updateChatSessions(data.session_id, userMessageText); // Add new session to sidebar
                }
            } else {
                appendMessage('ai', `Error: ${data.error || 'Something went wrong.'}`, new Date());
            }
        } catch (error) {
            console.error('Fetch error:', error);
            appendMessage('ai', 'Oops! Could not connect to the AI. Please try again.', new Date());
        }
    }

    sendMessageBtn.addEventListener('click', () => {
        sendMessage(chatInput.value);
    });

    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage(chatInput.value);
        }
    });

    uploadImageBtn.addEventListener('click', () => {
        imageUpload.click();
    });

    imageUpload.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        // In a real app, upload the file to cloud storage (e.g., AWS S3, Render's disk)
        // and get a publicly accessible URL before sending to AI.
        // For this conceptual example, we'll just simulate the URL.
        const simulatedImageUrl = `/media/temp_uploads/${file.name}`; // This needs a real upload endpoint

        appendMessage('user', `Uploading image: ${file.name}...`, new Date());

        // Simulate upload delay or actual upload process
        // For the AI to process, the image needs to be accessible via URL or encoded.
        // The `analyze_crop_image` tool expects a URL.
        // You'd have a Django view for image upload that returns the URL.
        
        // Example of *how* to call the AI with image URL:
        sendMessage(`Analyze this image: ${simulatedImageUrl}`, true, simulatedImageUrl);
        imageUpload.value = ''; // Clear file input
    });

    newChatBtn.addEventListener('click', () => {
        currentSessionId = null;
        chatMessages.innerHTML = ''; // Clear messages
        currentChatTitle.textContent = 'New Chat';
    });

    chatSessionsList.addEventListener('click', async (event) => {
        const listItem = event.target.closest('li');
        if (listItem && listItem.dataset.sessionId) {
            currentSessionId = listItem.dataset.sessionId;
            chatMessages.innerHTML = ''; // Clear current messages
            currentChatTitle.textContent = listItem.textContent.split('(')[0].trim(); // Set title from clicked session

            try {
                const response = await fetch(`/chat/history/${currentSessionId}/`);
                const data = await response.json();
                if (response.ok) {
                    data.messages.forEach(msg => appendMessage(msg.sender, msg.message, msg.timestamp));
                    currentChatTitle.textContent = data.title; // Use official title from history
                } else {
                    appendMessage('ai', `Error loading history: ${data.error}`, new Date());
                }
            } catch (error) {
                console.error('Error fetching chat history:', error);
                appendMessage('ai', 'Failed to load chat history.', new Date());
            }
        }
    });

    function updateChatSessions(sessionId, title) {
        // Add new session to the top of the sidebar list
        const listItem = document.createElement('li');
        listItem.classList.add('list-group-item');
        listItem.dataset.sessionId = sessionId;
        listItem.innerHTML = `${title} <small class="text-muted">(${new Date().toLocaleString()})</small>`;
        chatSessionsList.prepend(listItem);
    }

</script>
{% endblock %}